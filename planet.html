<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“š Daydreamå°èªªæ›¸åŸ</title>
    <style>
        :root{--bg:#f4f4f4;--card:#fff;--text:#111;--muted:#666;--border:#ddd;--accent:#4f46e5;--success:#22c55e}
        body.dark{--bg:#0f1220;--card:#151936;--text:#e8e9ff;--muted:#b6b8ff;--border:#2a2f6b;--accent:#8b8cff}
        body.green{--bg:#eef7f1;--card:#f7fff9;--text:#103b2a;--muted:#3a6b57;--border:#cce3d6;--accent:#2f855a}
        
        body{background:var(--bg);color:var(--text);font-family: Arial, "Microsoft JhengHei", sans-serif;transition:.2s;line-height:1.6;margin:0}
        .container{max-width:900px;margin:auto;padding:20px}
        
        /* å°è¦½ */
        .nav-tabs {display: flex; gap: 20px; border-bottom: 2px solid var(--border); margin-bottom: 20px;}
        .nav-link {padding: 10px 20px; cursor: pointer; font-weight: bold; color: var(--muted); border-bottom: 3px solid transparent;}
        .nav-link.active {color: var(--accent); border-bottom-color: var(--accent);}

        .user-bar{display:none; justify-content:flex-end; align-items:center; gap:10px; margin-bottom:10px; font-size:14px}
        .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom: 20px;}
        
        .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;}
        .card{background:var(--card);border-radius:12px;padding:16px;border:1px solid var(--border);transition:.2s;}
        
        /* ç·¨è¼¯å™¨æ¨£å¼ */
        .editor-zone { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-top: 20px; }
        .chapter-item { background: rgba(0,0,0,0.03); paddingé¦–é </h1>
        <div class="modeBtns">
            <button onclick="setTheme('dark')">ğŸŒ™</button>
            <button onclick="setTheme('green')">ğŸŸ¢</button>
            <button onclick="setTheme('light')">â˜€ï¸</button>
        </div>
    </div>

    </div>

    <div class="nav-tabs" id="mainNav" style="display:none;">
        <div class="nav-link active" id="tab-market" onclick="switchTab('market')">ğŸŒ ä½œå“å»£å ´</div>
        <div class="nav-link" id="tab-my" onclick="switchTab('my')">âœï¸ æˆ‘çš„å‰µä½œ</div>
    </div>

    <div id="page-market" class="hidden">
        <div style="margin-bottom:20px; border:1px dashed var(--accent); padding:15px; border-radius:10px;">
            <h4>ğŸ“¥ å°å…¥ä»£ç¢¼</h4>
            <input id="importCode" placeholder="è²¼ä¸Šä½œå“ä»£ç¢¼..." />
            <button onclick="importNovel()">å°å…¥</button>
        </div>
        <div class="grid" id="marketGrid"></div>
        <div id="marketViewer" class="viewer hidden"></div>
    </div>

    <div id="page-my" class="hidden">
        <div id="my-list-view">
            <h2>â• æ–°å¢ä½œå“</h2>
            <div style="display: flex; gap: 8px; margin-bottom:20px;">
                <input id="novelTitle" placeholder="æ›¸å..." />
                <button class="primary" onclick="addNovel()">å‰µå»º</button>
                  <div class="grid" id="myGrid"></div>
        </div>

        <div id="my-editor-view" class="hidden">
            <button onclick="exitEditor()">â¬…ï¸ è¿”å›æ¸…å–®</button>
            <div class="editor-zone">
                <h2 id="editingNovelName"></h2>
                <input id="chapterTitle" placeholder="ç« ç¯€æ¨™é¡Œ">
                <textarea id="chapterContent" placeholder="åœ¨æ­¤è¼¸å…¥å…§å®¹... (ç³»çµ±æœƒè‡ªå‹•æš«å­˜è‰ç¨¿)"></textarea>
                <button class="primary" id="saveBtn" onclick="saveChapter()">ç™¼ä½ˆ/æ›´æ–°ç« ç¯€</button>
                <hr>
                <h4>ç« ç¯€æ¸…å–®</h4>
                <div id="chapterList"></div>
            </div>
        </div>
    </div>
</div>

<script>
let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
let isSignUpMode = false;
let myNovels = [];
let editingIndex = null;
let editingChapterIdx = null;

// --- ç™»å…¥è¨»å†Š ---
function toggleAuthMode() {
    isSignUpMode = !isSignUpMode;
    document.getElementById('authTitle').innerText = isSignUpMode ? "ğŸ“ å‰µä½œè€…è¨»å†Š" : "ğŸ”‘ å‰µä½œè€…ç™»å…¥";
    document.getElementById('toggleAuthBtn').innerText = isSignUpMode ? "å·²æœ‰å¸³è™Ÿï¼Ÿé»æ­¤ç™»å…¥" : "é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿç«‹å³è¨»å†Š";
}

function handleAuth() {
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value.trim();
    let users = JSON.parse(localStorage.getItem('users')) || {};
    if(isSignUpMode) {
        if(users[u]) return alert('å¸³è™Ÿå·²å­˜åœ¨');
        users[u] = { password: p, data: [] };
        localStorage.setItem('users', JSON.stringify(users));
        alert('è¨»å†ŠæˆåŠŸï¼è«‹ç™»å…¥'); toggleAuthMode();
    } else {
        if(users[u] && users[u].password === p) {
            currentUser = u;
            localStorage.setItem('currentUser', JSON.stringify(u));
            initApp();
        } else { alert('å¸³å¯†éŒ¯èª¤'); }
    }
}

function initApp() {
    if(!currentUser) return;
    document.getElementById('authOverlay').style.display = 'none';
    document.getElementById('userBar').style.display = 'flex';
    document.getElementById('mainNav').style.display = 'flex';
    document.getElementById('welcomeMsg').innerText = `ä½ å¥½ï¼Œ${currentUser}`;
    const users = JSON.parse(localStorage.getItem('users'));
    myNovels = users[currentUser].data || [];
    switchTab('market');
}

// --- åˆ†é åˆ‡æ› ---
function switchTab(tab) {
    document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');
    document.getElementById('page-market').className = tab==='market' ? '' : 'hidden';
    document.getElementById('page-my').className = tab==='my' ? '' : 'hidden';
    if(tab === 'market') renderMarket(); else renderMy();
}

// --- æˆ‘çš„å‰µä½œï¼šç·¨è¼¯åŠŸèƒ½ ---
function renderMy() {
    const grid = document.getElementById('myGrid');
    grid.innerHTML = '';
    myNovels.forEach((n, i) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <h3>${n.title}</h3>
            <button class="primary" onclick="enterEditor(${i})">ğŸ“ ç·¨è¼¯ç« ç¯€</button>
            <button onclick="shareNovel(${i})">ğŸ“¤ åˆ†äº«</button>
            <button style="color:red; border:none;" onclick="deleteNovel(${i})">ğŸ—‘ï¸ åˆªé™¤</button>
        `;
        grid.appendChild(card);
    });
}

function enterEditor(i) {
    editingIndex = i;
    editingChapterIdx = null;
    document.getElementById('my-list-view').classList.add('hidden');
    document.getElementById('my-editor-view').classList.remove('hidden');
    document.getElementById('editingNovelName').innerText = `æ­£åœ¨ç·¨è¼¯ï¼šã€Š${myNovels[i].title}ã€‹`;
    document.getElementById('chapterTitle').value = '';
    document.getElementById('chapterContent').value = '';
    renderChapterList();
}

function exitEditor() {
    editingIndex = null;
    document.getElementById('my-list-view').classList.remove('hidden');
    document.getElementById('my-editor-view').classList.add('hidden');
    renderMy();
}

function renderChapterList() {
    const list = document.getElementById('chapterList');
    list.innerHTML = '';
    myNovels[editingIndex].chapters.forEach((c, idx) => {
        const div = document.createElement('div');
        div.className = 'chapter-item';
        div.innerHTML = `<span>ç¬¬ ${idx+1} ç« ï¼š${c.title}</span> 
                         <div><button onclick="editSpecificChapter(${idx})">æ”¹</button>
                         <button onclick="deleteChapter(${idx})">åˆª</button></div>`;
        list.appendChild(div);
    });
}

function saveChapter() {
    const t = document.getElementById('chapterTitle').value.trim();
    const c = document.getElementById('chapterContent').value.trim();
    if(!c) return alert('å…§å®¹ä¸èƒ½ç‚ºç©º');

    if(editingChapterIdx !== null) {
        myNovels[editingIndex].chapters[editingChapterIdx] = { title: t, content: c };
    } else {
        myNovels[editingIndex].chapters.push({ title: t, content: c });
    }
    
    saveToStorage();
    editingChapterIdx = null;
    document.getElementById('chapterTitle').value = '';
    document.getElementById('chapterContent').value = '';
    document.getElementById('saveBtn').innerText = "ç™¼ä½ˆ/æ›´æ–°ç« ç¯€";
    renderChapterList();
}

function editSpecificChapter(idx) {
    editingChapterIdx = idx;
    const c = myNovels[editingIndex].chapters[idx];
    document.getElementById('chapterTitle').value = c.title;
    document.getElementById('chapterContent').value = c.content;
    document.getElementById('saveBtn').innerText = "ğŸ’¾ å„²å­˜ä¿®æ”¹";
}

function deleteChapter(idx) {
    if(confirm('ç¢ºå®šåˆªé™¤ç« ç¯€ï¼Ÿ')) {
        myNovels[editingIndex].chapters.splice(idx, 1);
        saveToStorage();
        renderChapterList();
    }
}

// --- å·¥å…· ---
function saveToStorage() {
    let users = JSON.parse(localStorage.getItem('users'));
    users[currentUser].data = myNovels;
    localStorage.setItem('users', JSON.stringify(users));
}

function addNovel() {
    const t = document.getElementById('novelTitle').value.trim();
    if(!t) return;
    myNovels.push({ title: t, chapters: [] });
    saveToStorage();
    renderMy();
    document.getElementById('novelTitle').value = '';
}

function deleteNovel(i) {
    if(confirm('åˆªé™¤æ•´éƒ¨ä½œå“ï¼Ÿ')) { myNovels.splice(i, 1); saveToStorage(); renderMy(); }
}

function shareNovel(i) {
    const n = myNovels[i];
    const code = btoa(unescape(encodeURIComponent(JSON.stringify({title: n.title, author: currentUser, chapters: n.chapters}))));
    prompt('åˆ†äº«ä»£ç¢¼ï¼š', code);
}

function importNovel() {
    const code = document.getElementById('importCode').value.trim();
    if(!code) return;
    try {
        const data = JSON.parse(decodeURIComponent(escape(atob(code))));
        let market = JSON.parse(localStorage.getItem('marketNovels')) || [];
        market.push(data);
        localStorage.setItem('marketNovels', JSON.stringify(market));
        renderMarket();
    } catch(e) { alert('ä»£ç¢¼éŒ¯èª¤'); }
}

function renderMarket() {
    const grid = document.getElementById('marketGrid');
    grid.innerHTML = '';
    const market = JSON.parse(localStorage.getItem('marketNovels')) || [];
    market.forEach((n, i) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<h3>${n.title}</h3><small>ä½œè€…: ${n.author}</small><br>
                         <button onclick="readMarket(${i})">è§€çœ‹</button>`;
        grid.appendChild(card);
    });
}

function readMarket(i) {
    const n = (JSON.parse(localStorage.getItem('marketNovels')))[i];
    const viewer = document.getElementById('marketViewer');
    viewer.classList.remove('hidden');
    viewer.innerHTML = `<h2>${n.title}</h2>` + n.chapters.map(c => `<h4>${c.title}</h4><p>${c.content}</p>`).join('<hr>');
    viewer.scrollIntoView();
}

function logout() { localStorage.removeItem('currentUser'); location.reload(); }
function setTheme(m) { document.body.className = m==='light'?'':m; }

if(currentUser) initApp();
</script>
</body>
</html>
