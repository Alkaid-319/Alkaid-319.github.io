<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“šDaydreamå°èªª</title>
    <style>
        :root{--bg:#f4f4f4;--card:#fff;--text:#111;--muted:#666;--border:#ddd;--accent:#4f46e5;--success:#22c55e}
        body.dark{--bg:#0f1220;--card:#151936;--text:#e8e9ff;--muted:#b6b8ff;--border:#2a2f6b;--accent:#8b8cff}
        body.green{--bg:#eef7f1;--card:#f7fff9;--text:#103b2a;--muted:#3a6b57;--border:#cce3d6;--accent:#2f855a}
        
        body{background:var(--bg);color:var(--text);font-family: Arial, "Microsoft JhengHei", sans-serif;transition:.2s;line-height:1.6;margin:0}
        .container{max-width:900px;margin:auto;padding:20px}
        
        /* å°è¦½åˆ†é  */
        .nav-tabs {display: flex; gap: 20px; border-bottom: 2px solid var(--border); margin-bottom: 20px;}
        .nav-link {padding: 10px 20px; cursor: pointer; font-weight: bold; color: var(--muted); border-bottom: 3px solid transparent;}
        .nav-link.active {color: var(--accent); border-bottom-color: var(--accent);}

        /* ä½¿ç”¨è€…åˆ— */
        .user-bar{display:none; justify-content:flex-end; align-items:center; gap:10px; margin-bottom:10px; font-size:14px}
        .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom: 20px;}
        
        /* å¡ç‰‡ä½ˆå±€ */
        .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-top:16px}
        .card{background:var(--card);border-radius:12px;padding:16px;border:1px solid var(--border);transition:.2s;position: relative;}
        .card:hover{transform:translateY(-4px);box-shadow: 0 4px 12px rgba(0,0,0,0.1)}
        
        /* æŒ‰éˆ•èˆ‡è¼¸å…¥ */
        button{border-radius:6px;border:1px solid var(--border);padding:8px 15px;background:var(--card);color:var(--text);cursor:pointer; font-size: 14px;}
        button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
        input,textarea{width:100%;margin:6px 0;padding:10px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--text);box-sizing: border-box;}
        
        /* ç™»å…¥è¨»å†Šå½ˆçª— */
        #authOverlay{position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000; display:flex; align-items:center; justify-content:center; backdrop-filter: blur(5px);}
        .auth-card{width:320px; background:var(--card); padding:30px; border-radius:15px; text-align:center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);}
        
        .hidden {display: none !important;}
        .public-badge {background: var(--accent); color: white; font-size: 11px; padding: 2px 8px; border-radius: 20px;}
    </style>
</head>
<body>
hello~æ­¡è¿ä¾†åˆ°Daydreamå°èªªæ›¸åŸ
<div id="authOverlay">
    <div class="auth-card">
        <h2 id="authTitle">ğŸ”‘ æ­¡è¿å›ä¾†</h2>
        <p id="authSub" style="color:var(--muted); font-size:14px;">è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼é–‹å•Ÿå‰µä½œç©ºé–“</p>
        <input id="username" placeholder="ä½¿ç”¨è€…åç¨±" />
        <input id="password" type="password" placeholder="å¯†ç¢¼" />
        <button class="primary" style="width:100%; margin-top:15px; padding:12px; font-weight:bold;" onclick="handleAuth()">é€²å…¥æ›¸åŸ</button>
        <div style="margin-top:20px; font-size:13px; color:var(--muted);">
            <span id="authSwitchText">é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ</span>
            <span style="color:var(--accent); cursor:pointer; font-weight:bold;" onclick="toggleAuthMode()" id="toggleAuthBtn">ç«‹å³è¨»å†Š</span>
        </div>
    </div>
</div>

<div class="container">
    <div class="user-bar" id="userBar">
        <span id="welcomeMsg" style="font-weight:bold;"></span>
        <button onclick="logout()">å®‰å…¨ç™»å‡º</button>
    </div>

    <div class="toolbar">
        <h1>ğŸ“š Daydream Square</h1>
        <div class="modeBtns">
            <button onclick="setTheme('dark')">ğŸŒ™</button>
            <button onclick="setTheme('green')">ğŸŸ¢</button>
            <button onclick="setTheme('light')">â˜€ï¸</button>
        </div>
    </div>

    <div class="nav-tabs" id="mainNav" style="display:none;">
        <div class="nav-link active" id="tab-market" onclick="switchTab('market')">ğŸŒ å»£å ´é¦–é </div>
        <div class="nav-link" id="tab-my" onclick="switchTab('my')">âœï¸ æˆ‘çš„å‰µä½œ</div>
    </div>

    <div id="page-market" class="hidden">
        <div style="background:var(--card); padding:20px; border-radius:12px; border:1px dashed var(--accent); margin-bottom:20px;">
            <h4 style="margin-top:0;">ğŸ“¥ å°å…¥ä½œå“ç¢¼</h4>
            <input id="importCode" placeholder="è²¼ä¸Šæœ‹å‹åˆ†äº«çš„ä½œå“ä»£ç¢¼..." />
            <button class="primary" onclick="importNovel()">ç¢ºèªå°å…¥</button>
        </div>
        <div class="grid" id="marketGrid"></div>
    </div>

    <div id="page-my" class="hidden">
        <div style="margin-bottom:20px;">
            <h2>â• æ–°å¢ä½œå“</h2>
            <div style="display: flex; gap: 8px;">
                <input id="novelTitle" placeholder="é€™æœ¬æ›¸çš„åå­—æ˜¯..." />
                <button class="primary" onclick="addNovel()">å‰µå»ºä½œå“</button>
            </div>
        </div>
        <div class="grid" id="myGrid"></div>
    </div>
</div>

<script>
// --- å…¨åŸŸè®Šæ•¸ ---
let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
let isSignUpMode = false;
let myNovels = [];
let marketNovels = JSON.parse(localStorage.getItem('marketNovels')) || [];

// --- 1. ç™»å…¥è¨»å†Šé‚è¼¯ ---
function toggleAuthMode() {
    isSignUpMode = !isSignUpMode;
    document.getElementById('authTitle').innerText = isSignUpMode ? "ğŸ“ å‰µä½œè€…è¨»å†Š" : "ğŸ”‘ æ­¡è¿å›ä¾†";
    document.getElementById('authSub').innerText = isSignUpMode ? "è¨»å†Šå¾Œè³‡æ–™å°‡å„²å­˜åœ¨æ­¤ç€è¦½å™¨" : "è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼é–‹å•Ÿå‰µä½œç©ºé–“";
    document.getElementById('authSwitchText').innerText = isSignUpMode ? "å·²ç¶“æœ‰å¸³è™Ÿï¼Ÿ" : "é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ";
    document.getElementById('toggleAuthBtn').innerText = isSignUpMode ? "é»æ­¤ç™»å…¥" : "ç«‹å³è¨»å†Š";
}

function handleAuth() {
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value.trim();
    if(!u || !p) return alert('è«‹å¡«å¯«å¸³è™Ÿèˆ‡å¯†ç¢¼');

    let users = JSON.parse(localStorage.getItem('users')) || {};

    if(isSignUpMode) {
        // è¨»å†Š
        if(users[u]) return alert('æ­¤åç¨±å·²è¢«ä½¿ç”¨ï¼Œè«‹æ›ä¸€å€‹');
        users[u] = { password: p, data: [] };
        localStorage.setItem('users', JSON.stringify(users));
        alert('è¨»å†ŠæˆåŠŸï¼è«‹é‡æ–°ç™»å…¥');
        toggleAuthMode();
    } else {
        // ç™»å…¥
        if(users[u] && users[u].password === p) {
            currentUser = u;
            localStorage.setItem('currentUser', JSON.stringify(u));
            initApp();
        } else {
            alert('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
        }
    }
}

function logout() {
    localStorage.removeItem('currentUser');
    location.reload();
}

// --- 2. åˆå§‹åŒ–æ‡‰ç”¨ ---
function initApp() {
    if(!currentUser) return;
    document.getElementById('authOverlay').style.display = 'none';
    document.getElementById('userBar').style.display = 'flex';
    document.getElementById('mainNav').style.display = 'flex';
    document.getElementById('welcomeMsg').innerText = `ä½ å¥½ï¼Œ${currentUser}`;
    
    // è®€å–è©²ä½¿ç”¨è€…çš„ä½œå“
    const users = JSON.parse(localStorage.getItem('users'));
    myNovels = users[currentUser].data || [];
    
    switchTab('market'); // é è¨­é¦–é 
}

// --- 3. é é¢åˆ‡æ› ---
function switchTab(tab) {
    document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');
    
    if(tab === 'market') {
        document.getElementById('page-market').classList.remove('hidden');
        document.getElementById('page-my').classList.add('hidden');
        renderMarket();
    } else {
        document.getElementById('page-market').classList.add('hidden');
        document.getElementById('page-my').classList.remove('hidden');
        renderMy();
    }
}

// --- 4. å»£å ´èˆ‡åˆ†äº«é‚è¼¯ ---
function renderMarket() {
    const grid = document.getElementById('marketGrid');
    grid.innerHTML = '';
    if(marketNovels.length === 0) {
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px;">å°šæœªå°å…¥ä»»ä½•å¤–éƒ¨ä½œå“ã€‚</div>';
    }
    marketNovels.forEach((n, i) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <h3>${n.title} <span class="public-badge">${n.author}</span></h3>
            <p style="font-size:12px;">ç« ç¯€æ•¸ï¼š${n.chapters.length}</p>
            <button onclick="alert('é–±è®€åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œç›®å‰åƒ…ä¾›å°å…¥å±•ç¤º')">é–±è®€å…§å®¹</button>
            <button style="color:red; border:none; margin-top:10px;" onclick="removeMarket(${i})">ç§»é™¤</button>
        `;
        grid.appendChild(card);
    });
}

function shareNovel(i) {
    const n = myNovels[i];
    const exportData = {
        title: n.title,
        author: currentUser,
        chapters: n.chapters
    };
    // å°‡ JSON è½‰ç‚º Base64 æ–¹ä¾¿å‚³é
    const code = btoa(unescape(encodeURIComponent(JSON.stringify(exportData))));
    prompt('é€™æ˜¯é€™éƒ¨å°èªªçš„ã€Œä½œå“ä»£ç¢¼ã€ï¼Œè¤‡è£½ç™¼çµ¦æœ‹å‹å¾Œï¼Œä»–å€‘å¯ä»¥åœ¨å»£å ´å°å…¥ï¼š', code);
}

function importNovel() {
    const code = document.getElementById('importCode').value.trim();
    if(!code) return;
    try {
        const decoded = JSON.parse(decodeURIComponent(escape(atob(code))));
        marketNovels.push(decoded);
        localStorage.setItem('marketNovels', JSON.stringify(marketNovels));
        document.getElementById('importCode').value = '';
        alert(`æˆåŠŸå°å…¥ã€Š${decoded.title}ã€‹ï¼`);
        renderMarket();
    } catch(e) {
        alert('ç„¡æ•ˆçš„ä½œå“ä»£ç¢¼ï¼');
    }
}

function removeMarket(i) {
    marketNovels.splice(i, 1);
    localStorage.setItem('marketNovels', JSON.stringify(marketNovels));
    renderMarket();
}

// --- 5. å€‹äººå‰µä½œé‚è¼¯ ---
function renderMy() {
    const grid = document.getElementById('myGrid');
    grid.innerHTML = '';
    myNovels.forEach((n, i) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <h3>${n.title}</h3>
            <div style="display:flex; flex-direction:column; gap:8px;">
                <button onclick="shareNovel(${i})">ğŸ“¤ åˆ†äº«ä½œå“ä»£ç¢¼</button>
                <button class="primary" onclick="alert('ç·¨è¼¯å™¨å¯æ²¿ç”¨å‰ç‰ˆé‚è¼¯é–‹ç™¼')">ğŸ“ ç·¨è¼¯ä½œå“</button>
                <button style="color:red;" onclick="deleteMy(${i})">ğŸ—‘ï¸ åˆªé™¤ä½œå“</button>
            </div>
        `;
        grid.appendChild(card);
    });
}

function addNovel() {
    const t = document.getElementById('novelTitle').value.trim();
    if(!t) return;
    myNovels.push({ title: t, chapters: [] });
    saveMyData();
    renderMy();
    document.getElementById('novelTitle').value = '';
}

function saveMyData() {
    let users = JSON.parse(localStorage.getItem('users'));
    users[currentUser].data = myNovels;
    localStorage.setItem('users', JSON.stringify(users));
}

function deleteMy(i) {
    if(confirm('ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™éƒ¨ä½œå“å—ï¼Ÿ')) {
        myNovels.splice(i, 1);
        saveMyData();
        renderMy();
    }
}

function setTheme(m) { document.body.className = (m === 'light') ? '' : m; }

// --- å•Ÿå‹•åˆå§‹åŒ– ---
if(currentUser) initApp();
</script>

</body>
</html>
