<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“š Daydreamå°èªªæ›¸åŸ</title>
<style>
    :root{--bg:#f4f4f4;--card:#fff;--text:#111;--muted:#666;--border:#ddd;--accent:#4f46e5;--success:#22c55e}
    body.dark{--bg:#0f1220;--card:#151936;--text:#e8e9ff;--muted:#b6b8ff;--border:#2a2f6b;--accent:#8b8cff}
    body.green{--bg:#eef7f1;--card:#f7fff9;--text:#103b2a;--muted:#3a6b57;--border:#cce3d6;--accent:#2f855a}
    
    body{background:var(--bg);color:var(--text);font-family: Arial, "Microsoft JhengHei", sans-serif;padding:20px;transition:.2s;line-height:1.6; margin:0;}
    .container{max-width:900px;margin:auto}
    
    /* --- å¸³è™Ÿé©—è­‰èˆ‡é ‚éƒ¨æ¬„ --- */
    #authOverlay{position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; display:flex; align-items:center; justify-content:center; backdrop-filter: blur(5px);}
    .auth-card{width:320px; background:var(--card); padding:30px; border-radius:15px; text-align:center; box-shadow: 0 10px 25px rgba(0,0,0,0.5);}
    .user-bar{display:none; justify-content:flex-end; align-items:center; gap:10px; margin-bottom:10px; font-size:14px; padding: 0 10px;}
    
    /* --- é€šç”¨ UI --- */
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom: 20px;}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-top:16px}
    .card{background:var(--card);border-radius:12px;padding:16px;border:1px solid var(--border);transition:.2s;position: relative;}
    .card:hover{transform:translateY(-4px);box-shadow: 0 4px 12px rgba(0,0,0,0.1)}
    
    .card h3{margin:0;display: flex; align-items: center; justify-content: space-between;}
    .card h3 .title-text {cursor:pointer; flex-grow: 1;}
    .card small{color:var(--muted)}
    
    .chapter{cursor:pointer;color:var(--accent);margin:8px 0; padding: 8px; border-bottom: 1px dashed var(--border)}
    .chapter:hover{background: rgba(0,0,0,0.05)}
    
    button{border-radius:6px;border:1px solid var(--border);padding:6px 12px;background:var(--card);color:var(--text);cursor:pointer; font-size: 14px; transition: 0.2s;}
    button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    
    input,textarea{width:100%;margin:6px 0;padding:10px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--text);box-sizing: border-box;}
    textarea{height:150px; resize: vertical;}
    
    /* --- åˆ†é å°è¦½åˆ— (New) --- */
    .nav-tabs { display: flex; gap: 15px; border-bottom: 2px solid var(--border); margin-bottom: 20px; }
    .nav-btn { background: none; border: none; padding: 10px 15px; font-size: 16px; font-weight: bold; color: var(--muted); cursor: pointer; border-bottom: 3px solid transparent; border-radius: 0; }
    .nav-btn:hover { color: var(--text); }
    .nav-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
    
    /* --- è¦–åœ–å€å¡Šæ§åˆ¶ --- */
    .view-section { display: none; animation: fadeIn 0.3s; }
    .view-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* ç¨ç«‹ä»‹é¢çš„æ¨£å¼å„ªåŒ– */
    .center-form { max-width: 500px; margin: 40px auto; text-align: center; padding: 40px; border: 1px dashed var(--border); border-radius: 15px; background: rgba(0,0,0,0.02); }
    .center-form h2 { margin-top: 0; margin-bottom: 20px; }

    /* --- é–±è®€æ¨¡å¼é™åˆ¶ --- */
    body.reading-mode .toolbar, 
    body.reading-mode h2, 
    body.reading-mode .nav-tabs, /* éš±è—å°è¦½åˆ— */
    body.reading-mode .view-section:not(.active), /* ç¢ºä¿åªé¡¯ç¤ºç•¶å‰å…§å®¹ */
    body.reading-mode .card-controls,
    body.reading-mode .chapter-input-area,
    body.reading-mode .card:not(.active-card),
    body.reading-mode .user-bar {display:none !important}

    body.reading-mode .container {max-width: 800px; padding-top: 50px;}
    body.reading-mode .card.active-card {border: none; background: transparent; box-shadow: none;}
    .exit-reading {display: none; position: fixed; top: 20px; right: 20px; z-index: 100; background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 30px;}
    body.reading-mode .exit-reading {display: block;}

    /* å­—é«”èª¿ç¯€å·¥å…· */
    .font-controls { display: none; gap: 10px; align-items: center; margin-bottom: 15px; justify-content: flex-end;}
    body.reading-mode .font-controls { display: flex; }

    .like{cursor:pointer;font-size:20px; transition: 0.2s;}
    .like.on{color:#f43f5e}
    .modeBtns button{margin-left:6px; font-size: 18px;}
    
    .card-controls { display: flex; align-items: center; gap: 8px; }
    .action-btn {font-size: 14px; opacity: 0.7; cursor: pointer; transition: 0.2s;}
    .action-btn:hover {opacity: 1; transform: scale(1.1);}
    .del-btn {color: #ff4d4d;}
    .share-btn {color: var(--accent);}
    
    .editing-active { border: 2px solid var(--success) !important; box-shadow: 0 0 10px rgba(34, 197, 94, 0.2); }
    
    .viewer{margin-top:15px; padding: 15px; background: rgba(0,0,0,0.03); border-radius: 8px;}
    .viewer h4 {margin-top: 0;}
    .viewer p {white-space: pre-wrap; word-wrap: break-word; font-size: 16px;}
</style>
</head>
<body>
hello~æ­¡è¿ä¾†åˆ°Daydreamå°èªªæ›¸åŸ
<div id="authOverlay">
    <div class="auth-card">
        <h2 id="authTitle">ğŸ”‘ å‰µä½œè€…ç™»å…¥</h2>
        <input id="username" placeholder="ä½¿ç”¨è€…åç¨±" />
        <input id="password" type="password" placeholder="å¯†ç¢¼" />
        <button class="primary" style="width:100%; margin-top:15px;" onclick="handleAuth()">é€²å…¥ç³»çµ±</button>
        <p style="margin-top:15px; font-size:13px; cursor:pointer; color:var(--accent)" onclick="toggleAuthMode()" id="toggleAuthBtn">ç«‹å³è¨»å†Šå¸³è™Ÿ</p>
    </div>
</div>

<div class="container">
    <div class="user-bar" id="userBar">
        <span id="welcomeMsg"></span>
        <button onclick="logout()">ç™»å‡º</button>
    </div>

    <button class="exit-reading" onclick="toggleReading()">é€€å‡ºé–±è®€ ğŸ“–</button>
  
    <div class="toolbar">
        <h1>ğŸ“š Daydreamé¦–é </h1>
        <div class="modeBtns">
            <button onclick="toggleDark()" title="å¤œé–“æ¨¡å¼">ğŸŒ™</button>
            <button onclick="toggleGreen()" title="è­·çœ¼æ¨¡å¼">ğŸŸ¢</button>
            <button onclick="toggleReading()" title="é–±è®€æ¨¡å¼">ğŸ“–</button>
        </div>
    </div>

    <div class="font-controls">
        <span>å­—é«”å¤§å°ï¼š</span>
        <button onclick="changeFontSize(-2)">A-</button>
        <button onclick="changeFontSize(2)">A+</button>
    </div>

    <div class="nav-tabs">
        <button class="nav-btn active" id="btn-shelf" onclick="switchTab('shelf')">ğŸ“š æˆ‘çš„æ›¸æ«ƒ</button>
        <button class="nav-btn" id="btn-add" onclick="switchTab('add')">â• æ–°å¢ä½œå“</button>
        <button class="nav-btn" id="btn-import" onclick="switchTab('import')">ğŸŒ å°å…¥ä½œå“</button>
    </div>

    <div id="view-shelf" class="view-section active">
        <div class="grid" id="bookGrid"></div>
    </div>

    <div id="view-add" class="view-section">
        <div class="center-form">
            <h2>ğŸ“ å‰µå»ºæ–°æ•…äº‹</h2>
            <p style="color:var(--muted)">é–‹å§‹ä¸€æ®µæ–°çš„æ—…ç¨‹ï¼Œç‚ºæ‚¨çš„æ•…äº‹å‘½åã€‚</p>
            <input id="novelTitle" placeholder="è«‹è¼¸å…¥å°èªªåç¨±..." style="font-size: 18px; padding: 15px;" />
            <br><br>
            <button class="primary" onclick="addNovel()" style="width: 100%; padding: 12px; font-size: 16px;">ç«‹å³æ–°å¢</button>
        </div>
    </div>

    <div id="view-import" class="view-section">
        <div class="center-form">
            <h2>ğŸ“¥ å°å…¥å¤–éƒ¨ä½œå“</h2>
            <p style="color:var(--muted)">å°‡æœ‹å‹åˆ†äº«çš„ä»£ç¢¼è²¼åœ¨ä¸‹æ–¹å³å¯é–±è®€ã€‚</p>
            <textarea id="importCode" placeholder="åœ¨æ­¤è²¼ä¸Šä½œå“åˆ†äº«ç¢¼ (Base64)..." style="height: 120px;"></textarea>
            <br><br>
            <button class="primary" onclick="importNovel()" style="width: 100%; padding: 12px; font-size: 16px;">è§£æä¸¦å°å…¥</button>
        </div>
    </div>

</div>

<script>
// --- å…¨åŸŸè®Šæ•¸èˆ‡å¸³è™Ÿç³»çµ± ---
let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
let users = JSON.parse(localStorage.getItem('users')) || {};
let novels = [];
let isSignUpMode = false;
let openIndex = null;
let currentFontSize = 16;

const cn = n => ['é›¶','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹','å'][n+1] || (n+1);
const chapterName = i => `ç¬¬ ${cn(i)} ç« `;

if(localStorage.getItem('mode')==='dark') document.body.classList.add('dark');
if(localStorage.getItem('mode')==='green') document.body.classList.add('green');

// --- åˆ†é åˆ‡æ›é‚è¼¯ (New) ---
function switchTab(tabName) {
    // ç§»é™¤æ‰€æœ‰ active ç‹€æ…‹
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));

    // åŠ ä¸Šæ–°çš„ active ç‹€æ…‹
    document.getElementById(`btn-${tabName}`).classList.add('active');
    document.getElementById(`view-${tabName}`).classList.add('active');
}

// --- å¸³è™Ÿé‚è¼¯ ---
function toggleAuthMode() {
    isSignUpMode = !isSignUpMode;
    document.getElementById('authTitle').innerText = isSignUpMode ? "ğŸ“ å¸³è™Ÿè¨»å†Š" : "ğŸ”‘ å‰µä½œè€…ç™»å…¥";
    document.getElementById('toggleAuthBtn').innerText = isSignUpMode ? "å·²æœ‰å¸³è™Ÿï¼Ÿé»æ­¤ç™»å…¥" : "ç«‹å³è¨»å†Šå¸³è™Ÿ";
}

function handleAuth() {
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value.trim();
    if(!u || !p) return alert('è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼');

    users = JSON.parse(localStorage.getItem('users')) || {}; 

    if(isSignUpMode) {
        if(users[u]) return alert('å¸³è™Ÿå·²å­˜åœ¨');
        users[u] = { password: p, data: [] };
        localStorage.setItem('users', JSON.stringify(users));
        alert('è¨»å†ŠæˆåŠŸï¼è«‹ç™»å…¥'); 
        toggleAuthMode();
    } else {
        if(users[u] && users[u].password === p) {
            currentUser = u;
            localStorage.setItem('currentUser', JSON.stringify(u));
            initApp();
        } else { alert('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤'); }
    }
}

function logout() {
    localStorage.removeItem('currentUser');
    location.reload();
}

function initApp() {
    if(!currentUser) return;
    document.getElementById('authOverlay').style.display = 'none';
    document.getElementById('userBar').style.display = 'flex';
    document.getElementById('welcomeMsg').innerText = `ä½ å¥½ï¼Œ${currentUser}`;
    
    users = JSON.parse(localStorage.getItem('users'));
    novels = users[currentUser].data || [];
    render();
}

const save = () => {
    if(!currentUser) return;
    users[currentUser].data = novels;
    localStorage.setItem('users', JSON.stringify(users));
};

// --- åŠŸèƒ½é‚è¼¯ ---

function toggleDark(){
    document.body.classList.toggle('dark');
    document.body.classList.remove('green');
    localStorage.setItem('mode', document.body.classList.contains('dark') ? 'dark' : 'light');
}

function toggleGreen(){
    document.body.classList.toggle('green');
    document.body.classList.remove('dark');
    localStorage.setItem('mode', document.body.classList.contains('green') ? 'green' : 'light');
}

function toggleReading(){
    if(openIndex === null && !document.body.classList.contains('reading-mode')) {
        alert('è«‹å…ˆå±•é–‹ä¸€æœ¬å°èªªå†é€²å…¥é–±è®€æ¨¡å¼');
        return;
    }
    document.body.classList.toggle('reading-mode');
}

function changeFontSize(delta) {
    currentFontSize += delta;
    const viewerP = document.querySelector('.viewer p');
    if(viewerP) viewerP.style.fontSize = currentFontSize + 'px';
}

function addNovel(){
    const t = document.getElementById('novelTitle').value.trim();
    if(!t) return alert('è«‹è¼¸å…¥åç¨±');
    novels.push({title:t, liked:false, chapters:[]});
    document.getElementById('novelTitle').value = '';
    
    save();
    render();
    
    // UXå„ªåŒ–ï¼šæ–°å¢å¾Œè‡ªå‹•è·³è½‰å›æ›¸æ«ƒ
    alert(`æˆåŠŸå‰µå»ºä½œå“ï¼šã€Š${t}ã€‹`);
    switchTab('shelf');
}

function shareNovel(e, i) {
    e.stopPropagation();
    const n = novels[i];
    const exportData = {
        title: n.title,
        author: currentUser,
        chapters: n.chapters
    };
    const code = btoa(unescape(encodeURIComponent(JSON.stringify(exportData))));
    prompt('è«‹è¤‡è£½ä¸‹æ–¹ä»£ç¢¼åˆ†äº«çµ¦æœ‹å‹ï¼š', code);
}

function importNovel() {
    const codeInput = document.getElementById('importCode');
    const code = codeInput.value.trim();
    if(!code) return alert('è«‹è¼¸å…¥ä»£ç¢¼');

    try {
        const data = JSON.parse(decodeURIComponent(escape(atob(code))));
        if(!data.title || !Array.isArray(data.chapters)) throw new Error('æ ¼å¼éŒ¯èª¤');

        novels.push({
            title: `[å°å…¥] ${data.title}`, 
            liked: false,
            chapters: data.chapters,
            isImported: true,
            originalAuthor: data.author || 'æœªçŸ¥'
        });
        
        save();
        render();
        alert(`æˆåŠŸå°å…¥ã€Š${data.title}ã€‹ï¼`);
        codeInput.value = '';
        
        // UXå„ªåŒ–ï¼šå°å…¥å¾Œè‡ªå‹•è·³è½‰å›æ›¸æ«ƒ
        switchTab('shelf');
    } catch(e) {
        alert('ç„¡æ•ˆçš„åˆ†äº«ç¢¼ï¼Œè«‹ç¢ºèªä»£ç¢¼æ˜¯å¦å®Œæ•´ã€‚');
        console.error(e);
    }
}

function editNovel(e, i){
    e.stopPropagation();
    const newTitle = prompt('è«‹è¼¸å…¥æ–°çš„å°èªªåç¨±', novels[i].title);
    if(newTitle === null) return;
    if(!newTitle.trim()) return alert('åç¨±ä¸èƒ½ç‚ºç©º');
    novels[i].title = newTitle.trim();
    save();
    render();
}

function deleteNovel(e, i) {
    e.stopPropagation();
    if(confirm(`ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ã€Š${novels[i].title}ã€‹å—ï¼Ÿ`)) {
        novels.splice(i, 1);
        if(openIndex === i) openIndex = null;
        save();
        render();
    }
}

function toggleOpen(i){
    openIndex = (openIndex === i) ? null : i;
    render();
}

function render(){
    const grid = document.getElementById('bookGrid');
    grid.innerHTML = '';
    
    if(novels.length === 0) {
        grid.innerHTML = `
            <div style="grid-column:1/-1; text-align:center; color:var(--muted); margin-top:50px;">
                <p>ğŸ“­ æ›¸æ«ƒç©ºç©ºçš„</p>
                <button onclick="switchTab('add')">å»æ–°å¢ç¬¬ä¸€æœ¬å°èªª</button>
            </div>`;
        return;
    }

    novels.forEach((n, i) => {
        const card = document.createElement('div');
        card.className = `card ${openIndex === i ? 'active-card' : ''}`;
        
        const isLiked = n.liked ? 'on' : '';
        const authorTag = n.isImported ? `<br><small style="font-size:12px">åŸä½œè€…: ${n.originalAuthor}</small>` : '';
        
        card.innerHTML = `
            <h3>
                <span class="title-text" onclick="toggleOpen(${i})">
                    ${n.title}
                </span>
                <span class="card-controls">
                    <span class="action-btn share-btn" onclick="shareNovel(event, ${i})" title="åˆ†äº«ä»£ç¢¼">ğŸ“¤</span>
                    <span class="action-btn edit-btn" onclick="editNovel(event, ${i})" title="é‡æ–°å‘½å">âœï¸</span>
                    <span class="action-btn del-btn" onclick="deleteNovel(event, ${i})" title="åˆªé™¤">ğŸ—‘ï¸</span>
                    <span class="action-btn like ${isLiked}" onclick="toggleLike(event, ${i})">â¤</span>
                </span>
            </h3>
            <small>${n.chapters.length} ç« ç¯€</small>
            ${authorTag}
            <div class="content" id="content-${i}"></div>
        `;
        
        grid.appendChild(card);
        if(openIndex === i) renderChapters(document.getElementById(`content-${i}`), i);
    });
}

function toggleLike(e, i) {
    e.stopPropagation();
    novels[i].liked = !novels[i].liked;
    save();
    render();
}

function renderChapters(container, i){
    const n = novels[i];
    let html = `<hr><div class="chapter-input-area">
        <input placeholder="ç« ç¯€æ¨™é¡Œï¼ˆå¯é¸ï¼‰" id="ct${i}">
        <textarea placeholder="è«‹åœ¨æ­¤è™•è¼¸å…¥ç« ç¯€å…§å®¹..." id="cc${i}"></textarea>
        <button class="primary" id="pubBtn${i}" onclick="addChapter(${i})">ç™¼ä½ˆç« ç¯€</button>
    </div><div id="chapter-list-${i}">`;
    
    container.innerHTML = html;
    
    const listDiv = document.getElementById(`chapter-list-${i}`);
    n.chapters.forEach((c, idx) => {
        const d = document.createElement('div');
        d.className = 'chapter';
        d.textContent = c.title ? `${chapterName(idx)}ï¼š${c.title}` : chapterName(idx);
        d.onclick = () => viewChapter(container, i, idx);
        listDiv.appendChild(d);
    });
}

function addChapter(i){
    const t = document.getElementById('ct'+i).value.trim();
    const c = document.getElementById('cc'+i).value.trim();
    if(!c) return alert('ç« ç¯€å…§å®¹ä¸èƒ½ç‚ºç©º');
    
    novels[i].chapters.push({
        title: t,
        content: c,
        time: new Date().toLocaleString()
    });
    save();
    render();
}

function viewChapter(container, i, idx){
    const c = novels[i].chapters[idx];
    const oldViewer = container.querySelector('.viewer');
    if(oldViewer) oldViewer.remove();
    
    const v = document.createElement('div');
    v.className = 'viewer';
    const displayTitle = c.title ? `${chapterName(idx)}ï¼š${c.title}` : chapterName(idx);
    
    v.innerHTML = `
        <h4>${displayTitle}</h4>
        <small style="color:var(--muted)">ç™¼ä½ˆæ™‚é–“ï¼š${c.time}</small>
        <p style="font-size:${currentFontSize}px">${c.content}</p>
        <div class="card-controls" style="margin-top:20px; display:flex; gap:10px;">
            <button onclick="editChapter(${i}, ${idx})">âœï¸ ç·¨è¼¯å…§å®¹</button>
            <button onclick="deleteChapter(${i}, ${idx})" style="color:red">ğŸ—‘ï¸ åˆªé™¤ç« ç¯€</button>
        </div>
    `;
    container.appendChild(v);
    v.scrollIntoView({behavior: 'smooth'});
}

function editChapter(i, idx){
    const c = novels[i].chapters[idx];
    const titleInput = document.getElementById('ct'+i);
    const contentTextarea = document.getElementById('cc'+i);
    const pubBtn = document.getElementById('pubBtn'+i);

    titleInput.value = c.title;
    contentTextarea.value = c.content;
    
    contentTextarea.classList.add('editing-active');
    titleInput.focus();
    titleInput.scrollIntoView({behavior: 'smooth'});

    pubBtn.textContent = "ğŸ’¾ å„²å­˜ä¿®æ”¹";
    pubBtn.classList.remove('primary');
    pubBtn.style.background = "#22c55e";
    pubBtn.style.color = "#fff";
    
    pubBtn.onclick = function() {
        const nt = titleInput.value.trim();
        const nc = contentTextarea.value.trim();
        if(!nc) return alert('å…§å®¹ä¸èƒ½ç‚ºç©º');
        
        novels[i].chapters[idx].title = nt;
        novels[i].chapters[idx].content = nc;
        novels[i].chapters[idx].time = new Date().toLocaleString() + " (å·²ç·¨è¼¯)";
        
        save();
        render(); 
    };
}

function deleteChapter(i, idx){
    if(!confirm('ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤ç« ç¯€å—ï¼Ÿ')) return;
    novels[i].chapters.splice(idx, 1);
    save();
    render();
}

if(currentUser) initApp();
</script>

</body>
</html>
