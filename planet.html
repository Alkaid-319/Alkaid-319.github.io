<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daydreamå°èªªæ›¸åŸ</title>
    <style>
        :root{--bg:#f4f4f4;--card:#fff;--text:#111;--muted:#666;--border:#ddd;--accent:#4f46e5;--success:#22c55e}
        body.dark{--bg:#0f1220;--card:#151936;--text:#e8e9ff;--muted:#b6b8ff;--border:#2a2f6b;--accent:#8b8cff}
        body.green{--bg:#eef7f1;--card:#f7fff9;--text:#103b2a;--muted:#3a6b57;--border:#cce3d6;--accent:#2f855a}
        
        body{background:var(--bg);color:var(--text);font-family: Arial, "Microsoft JhengHei", sans-serif;transition:.2s;line-height:1.6;margin:0}
        .container{max-width:900px;margin:auto;padding:20px}
        
        /* å°è¦½åˆ†é  */
        .nav-tabs {display: flex; gap: 20px; border-bottom: 2px solid var(--border); margin-bottom: 20px;}
        .nav-link {padding: 10px 20px; cursor: pointer; font-weight: bold; color: var(--muted); border-bottom: 3px solid transparent;}
        .nav-link.active {color: var(--accent); border-bottom-color: var(--accent);}

        .user-bar{display:none; justify-content:flex-end; align-items:center; gap:10px; margin-bottom:10px; font-size:14px}
        .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom: 20px;}
        
        .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-top:16px}
        .card{background:var(--card);border-radius:12px;padding:16px;border:1px solid var(--border);transition:.2s;position: relative;}
        .card:hover{transform:translateY(-4px);box-shadow: 0 4px 12px rgba(0,0,0,0.1)}
        
        button{border-radius:6px;border:1px solid var(--border);padding:6px 12px;background:var(--card);color:var(--text);cursor:pointer; font-size: 14px;}
        button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
        
        input,textarea{width:100%;margin:6px 0;padding:10px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--text);box-sizing: border-box;}
        textarea{height:120px;}

        /* å»£å ´å°ˆå±¬æ¨£å¼ */
        .public-badge {background: var(--accent); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 5px;}
        .import-area {background: var(--card); padding: 15px; border-radius: 8px; border: 1px dashed var(--accent); margin-bottom: 20px;}

        #authOverlay{position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; display:flex; align-items:center; justify-content:center; backdrop-filter: blur(5px);}
        .auth-card{width:320px; background:var(--card); padding:30px; border-radius:15px; text-align:center;}
        
        .viewer{margin-top:15px; padding: 20px; background: rgba(0,0,0,0.03); border-radius: 8px; border-left: 4px solid var(--accent);}
        .hidden {display: none !important;}
    </style>
</head>
<body>
hello~æ­¡è¿ä¾†åˆ°Daydreamå°èªªæ›¸åŸ
<div id="authOverlay">
    <div class="auth-card">
        <h2 id="authTitle">ğŸ”‘ å‰µä½œè€…ç™»å…¥</h2>
        <input id="username" placeholder="å¸³è™Ÿ" />
        <input id="password" type="password" placeholder="å¯†ç¢¼" />
        <button class="primary" style="width:100%; margin-top:10px; padding:12px" onclick="handleAuth()">é€²å…¥æ›¸åŸ</button>
        <p style="font-size:13px; color:var(--muted); margin-top:15px; cursor:pointer" onclick="toggleAuthMode()" id="toggleAuthBtn">æ–°ä½œè€…ï¼Ÿé»æ­¤è¨»å†Š</p>
    </div>
</div>

<div class="container">
    <div class="user-bar" id="userBar">
        <span id="welcomeMsg"></span>
        <button onclick="logout()">ç™»å‡º</button>
    </div>

    <div class="toolbar">
        <h1>ğŸ“šé¦–é </h1>
        <div class="modeBtns">
            <button onclick="setTheme('dark')">ğŸŒ™</button>
            <button onclick="setTheme('green')">ğŸŸ¢</button>
            <button onclick="setTheme('light')">â˜€ï¸</button>
        </div>
    </div>

    <div class="nav-tabs">
        <div class="nav-link active" id="tab-market" onclick="switchTab('market')">ğŸŒ ä½œå“å»£å ´</div>
        <div class="nav-link" id="tab-my" onclick="switchTab('my')">âœï¸ æˆ‘çš„å‰µä½œ</div>
    </div>

    <div id="page-market">
        <div class="import-area">
            <h4>ğŸ“¥ å°å…¥åˆ¥äººåˆ†äº«çš„ä½œå“</h4>
            <p style="font-size: 12px; color: var(--muted);">è²¼ä¸Šä½œè€…æä¾›çš„ã€Œä½œå“ä»£ç¢¼ã€å³å¯åœ¨é¦–é é–±è®€ã€‚</p>
            <input id="importCode" placeholder="è«‹è²¼ä¸Šä½œå“ä»£ç¢¼..." />
            <button class="primary" onclick="importNovel()">å°å…¥ä½œå“</button>
        </div>
        <div class="grid" id="marketGrid"></div>
    </div>

    <div id="page-my" class="hidden">
        <div class="add-section">
            <h2>â• é–‹å•Ÿæ–°ä½œå“</h2>
            <div style="display: flex; gap: 8px;">
                <input id="novelTitle" placeholder="ä½œå“åç¨±..." />
                <button class="primary" onclick="addNovel()">æ–°å¢</button>
            </div>
        </div>
        <div class="grid" id="myGrid"></div>
    </div>
</div>

<script>
let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
let novels = []; // æˆ‘çš„ä½œå“
let marketNovels = JSON.parse(localStorage.getItem('marketNovels')) || []; // å°å…¥çš„ä½œå“

// --- åˆå§‹åŒ–èˆ‡åˆ‡æ› ---
function switchTab(tab) {
    document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');
    
    if(tab === 'market') {
        document.getElementById('page-market').classList.remove('hidden');
        document.getElementById('page-my').classList.add('hidden');
        renderMarket();
    } else {
        document.getElementById('page-market').classList.add('hidden');
        document.getElementById('page-my').classList.remove('hidden');
        renderMy();
    }
}

// --- å»£å ´é‚è¼¯ (åˆ¥äººä½œå“) ---
function renderMarket() {
    const grid = document.getElementById('marketGrid');
    grid.innerHTML = '';
    if(marketNovels.length === 0) {
        grid.innerHTML = '<p style="text-align:center; padding:20px; color:var(--muted);">å»£å ´ç›®å‰ç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»å°å…¥æœ‹å‹çš„ä½œå“ä»£ç¢¼å§ï¼</p>';
        return;
    }
    marketNovels.forEach((n, i) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <h3>${n.title} <span class="public-badge">ä½œè€…: ${n.author || 'åŒ¿å'}</span></h3>
            <p style="font-size:12px; color:var(--muted)">ç« ç¯€æ•¸: ${n.chapters.length}</p>
            <button onclick="viewPublicNovel(${i})">é–‹å§‹é–±è®€</button>
            <button style="color:red; border:none; background:none; font-size:12px" onclick="removeMarket(${i})">å¾æ¸…å–®ç§»é™¤</button>
        `;
        grid.appendChild(card);
    });
}

function importNovel() {
    const code = document.getElementById('importCode').value.trim();
    if(!code) return;
    try {
        const novelObj = JSON.parse(atob(code)); // è§£ç¢¼
        marketNovels.push(novelObj);
        localStorage.setItem('marketNovels', JSON.stringify(marketNovels));
        document.getElementById('importCode').value = '';
        alert(`æˆåŠŸå°å…¥ä½œå“ã€Š${novelObj.title}ã€‹ï¼`);
        renderMarket();
    } catch(e) {
        alert('ç„¡æ•ˆçš„ä½œå“ä»£ç¢¼ï¼');
    }
}

function removeMarket(i) {
    marketNovels.splice(i, 1);
    localStorage.setItem('marketNovels', JSON.stringify(marketNovels));
    renderMarket();
}

// --- æˆ‘çš„ä½œå“é‚è¼¯ ---
function renderMy() {
    const grid = document.getElementById('myGrid');
    grid.innerHTML = '';
    novels.forEach((n, i) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <h3>${n.title}</h3>
            <button onclick="shareNovel(${i})">ğŸ“¤ åˆ†äº«ä½œå“ä»£ç¢¼</button>
            <button class="primary" onclick="openEditor(${i})">ğŸ“ ç¹¼çºŒå‰µä½œ</button>
            <div id="editor-${i}"></div>
        `;
        grid.appendChild(card);
    });
}

function shareNovel(i) {
    const n = novels[i];
    const shareData = {
        title: n.title,
        author: currentUser,
        chapters: n.chapters
    };
    const code = btoa(unescape(encodeURIComponent(JSON.stringify(shareData)))); // ç·¨ç¢¼
    prompt('é€™æ˜¯ä½ çš„ã€Œä½œå“ä»£ç¢¼ã€ï¼Œè¤‡è£½ç™¼çµ¦æœ‹å‹ï¼Œä»–å€‘å°±èƒ½åœ¨å»£å ´å°å…¥ä½ çš„ä½œå“äº†ï¼š', code);
}

// --- åŸºç¤åŠŸèƒ½ (æ²¿ç”¨å‰ç‰ˆ) ---
function handleAuth() {
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value.trim();
    let users = JSON.parse(localStorage.getItem('users')) || {};
    if(users[u] && users[u].password === p) {
        currentUser = u;
        localStorage.setItem('currentUser', JSON.stringify(u));
        initApp();
    } else { alert('ç™»å…¥å¤±æ•—'); }
}

function initApp() {
    if(!currentUser) return;
    document.getElementById('authOverlay').style.display = 'none';
    document.getElementById('userBar').style.display = 'flex';
    document.getElementById('welcomeMsg').innerText = `ä½ å¥½ï¼Œ${currentUser}`;
    const users = JSON.parse(localStorage.getItem('users'));
    novels = users[currentUser].data || [];
    switchTab('market'); // ç™»å…¥å¾Œé¦–é æ˜¯å»£å ´
}

function addNovel() {
    const t = document.getElementById('novelTitle').value.trim();
    if(!t) return;
    novels.push({ title: t, chapters: [] });
    save();
    renderMy();
}

const save = () => {
    let users = JSON.parse(localStorage.getItem('users'));
    users[currentUser].data = novels;
    localStorage.setItem('users', JSON.stringify(users));
};

function setTheme(m) { document.body.className = (m === 'light') ? '' : m; }
function logout() { localStorage.removeItem('currentUser'); location.reload(); }
function toggleAuthMode() { /* ç°¡åŒ–ç‰ˆ */ alert('è«‹ç›´æ¥è¼¸å…¥å¸³è™Ÿå¯†ç¢¼ï¼Œè‹¥ç„¡å¸³è™Ÿè«‹å…ˆåœ¨ LocalStorage å»ºç«‹ï¼ˆæˆ–é–‹ç™¼ä¸€å€‹ç°¡å–®è¨»å†ŠåŠŸèƒ½ï¼‰'); }

// å•Ÿå‹•
if(currentUser) initApp();
</script>

</body>
</html>
